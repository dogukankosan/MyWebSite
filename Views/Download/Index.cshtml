@model IEnumerable<MyWebSite.Models.FileListItem>
@{
    Layout = null;
    ViewData["Title"] = "İndirilebilir Dosyalar";
    var packages = (Model ?? Enumerable.Empty<MyWebSite.Models.FileListItem>())
        .GroupBy(x => x.PackageKey)
        .OrderBy(g => g.Key)
        .ToList();
    string SizeFmt(long bytes)
    {
        decimal d = bytes;
        string[] units = { "B", "KB", "MB", "GB", "TB" };
        int i = 0;
        while (d >= 1024 && i < units.Length - 1) { d /= 1024; i++; }
        return $"{Math.Round(d, 2)} {units[i]}";
    }
    string? toastType = TempData["Type"]?.ToString();
    string? toastMsg = TempData["Message"]?.ToString();
    string toastCss = toastType switch
    {
        "success" => "alert alert-success",
        "error" => "alert alert-danger",
        "warning" => "alert alert-warning",
        _ => "alert alert-info"
    };
}
<!doctype html>
<html lang="tr">
<head>
    <link rel="icon" type="image/png" href="@Url.Content("~/css/software-developer.png")" />
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="robots" content="noindex, nofollow, noarchive, nosnippet, noimageindex">
    <meta name="googlebot" content="noindex, nofollow, noarchive, nosnippet, noimageindex">
    <title>@ViewData["Title"]</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
          rel="stylesheet"
          integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
          crossorigin="anonymous">
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    <style>
        body {
            background: #f7f7fb;
        }
        .navbar-brand {
            font-weight: 600;
        }
        .badge.bg-outline {
            color: #0d6efd;
            border: 1px solid #0d6efd;
            background: transparent;
        }
        .accordion-button .badge {
            font-size: .85rem;
        }
        .accordion-button:focus {
            box-shadow: none;
        }
        .card {
            border-radius: 14px;
        }
        .file-cell {
            max-width: 520px;
        }
        .stat {
            font-size: .9rem;
            color: #6c757d;
        }
        .chip {
            border-radius: 999px;
            padding: .25rem .6rem;
            background: #eef4ff;
        }
        .table-wrap {
            display: none;
        }
        .cards-wrap {
            display: block;
        }
        @@media (min-width: 768px) {
            .table-wrap {
                display: block;
            }
            .cards-wrap {
                display: none;
            }
        }
        .file-card {
            border-bottom: 1px solid #eee;
            padding: .75rem 1rem;
            background: #fff;
        }
            .file-card:last-child {
                border-bottom: 0;
            }
        .file-title {
            font-weight: 600;
            word-break: break-all;
        }
        .file-meta {
            font-size: .9rem;
            color: #6c757d;
        }
        .sticky-actions {
            position: sticky;
            bottom: 0;
            z-index: 5;
            background: rgba(255,255,255,.9);
            backdrop-filter: blur(2px);
            border-top: 1px solid #eee;
            padding: .5rem .75rem;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg bg-white border-bottom shadow-sm">
        <div class="container">
            <a class="navbar-brand" asp-controller="Download" asp-action="Index">  <i class="bi bi-cloud-arrow-down"></i>  Dosya Merkezi</a>
            <div class="ms-auto">
                <a class="btn btn-outline-secondary btn-sm" href="~/"><i class="bi bi-house"></i> Siteye Dön</a>
            </div>
        </div>
    </nav>
    <main class="container my-4">
        @if (!string.IsNullOrWhiteSpace(toastMsg))
        {
            <div class="@toastCss alert-dismissible fade show" role="alert">
                @toastMsg
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Kapat"></button>
            </div>
        }
        <div class="d-flex align-items-center justify-content-between mb-3">
            <h3 class="mb-0">@ViewData["Title"]</h3>
            <a class="btn btn-outline-secondary btn-sm" asp-action="Index">
                <i class="bi bi-x-circle"></i> Filtreyi Temizle
            </a>
        </div>
        <div class="card shadow-sm mb-3">
            <div class="card-body">
                <form method="get" class="row g-2">
                    <div class="col-12 col-md-4">
                        <label class="form-label">Paket</label>
                        <input name="packageKey" value="@(Context.Request.Query["packageKey"])"
                               class="form-control" placeholder="Paket anahtarı" />
                    </div>
                    <div class="col-6 col-md-3">
                        <label class="form-label">Versiyon</label>
                        <input name="version"
                               value="@(Context.Request.Query["version"])"
                               class="form-control"
                               placeholder="1.2.3"
                               inputmode="numeric"
                               pattern="^\d+\.\d+\.\d+$"
                               title="Versiyon yalnızca 1.2.3 biçiminde olmalı (sadece rakam ve nokta)." />
                        <div class="form-text">Biçim: <code>1.2.3</code></div>
                    </div>
                    <div class="col-6 col-md-3">
                        <label class="form-label">Dosya adı</label>
                        <input name="q"
                               value="@(Context.Request.Query["q"])"
                               class="form-control"
                               placeholder="paket-1.0.1.zip"
                               pattern="^[^\\/:*?&quot;&lt;&gt;|]+\\.(zip|rar)$"
                               title="Dosya adı yalnızca .zip veya .rar ile bitmelidir ve yasak karakter içeremez." />
                        <div class="form-text">Örn: <code>paket-1.0.1.zip</code> veya <code>paket-1.0.1.rar</code></div>
                    </div>
                    <div class="col-12 col-md-2 d-grid">
                        <label class="form-label d-none d-md-block">&nbsp;</label>
                        <button class="btn btn-primary" type="submit">
                            <i class="bi bi-funnel"></i> Filtrele
                        </button>
                    </div>
                </form>
            </div>
        </div>
        @if (!packages.Any())
        {
            <div class="alert alert-info mb-0">Kriterlere uygun aktif dosya bulunamadı.</div>
        }
        else
        {
            <div class="accordion" id="accPackages">
                @{
                    int pIndex = 0;
                }
                @foreach (var pkg in packages)
                {
                    string? pkgHeadingId = $"pkg_h{pIndex}";
                    string? pkgCollapseId = $"pkg_c{pIndex}";
                    var pkgTotalSize = pkg.Sum(x => x.FileSizeBytes);
                    int pkgFileCount = pkg.Count();
                    var versions = pkg
                    .GroupBy(x => x.Version)
                    .OrderByDescending(v => v.Key)
                    .ToList();
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="@pkgHeadingId">
                            <button class="accordion-button collapsed d-flex justify-content-between gap-2"
                                    type="button"
                                    data-bs-toggle="collapse"
                                    data-bs-target="#@pkgCollapseId"
                                    aria-expanded="false"
                                    aria-controls="@pkgCollapseId">
                                <div class="me-auto d-flex align-items-center gap-2">
                                    <span class="badge bg-secondary">@pkg.Key</span>
                                    <span class="badge bg-info">@versions.Count() versiyon</span>
                                </div>
                                <div class="stat">
                                    <span class="me-3"><i class="bi bi-files"></i> @pkgFileCount dosya</span>
                                    <span><i class="bi bi-hdd-network"></i> @SizeFmt(pkgTotalSize)</span>
                                </div>
                            </button>
                        </h2>
                        <div id="@pkgCollapseId" class="accordion-collapse collapse" aria-labelledby="@pkgHeadingId" data-bs-parent="#accPackages">
                            <div class="accordion-body">
                                <div class="accordion" id="accVersions_@pIndex">
                                    @{
                                        int vIndex = 0;
                                    }
                                    @foreach (var vg in versions)
                                    {
                                        string vHeadingId = $"ver_h{pIndex}_{vIndex}";
                                        string vCollapseId = $"ver_c{pIndex}_{vIndex}";
                                        var vTotalSize = vg.Sum(x => x.FileSizeBytes);
                                        int vFileCount = vg.Count();
                                        <div class="accordion-item mb-2">
                                            <h2 class="accordion-header" id="@vHeadingId">
                                                <button class="accordion-button collapsed d-flex justify-content-between gap-2"
                                                        type="button"
                                                        data-bs-toggle="collapse"
                                                        data-bs-target="#@vCollapseId"
                                                        aria-expanded="false"
                                                        aria-controls="@vCollapseId">
                                                    <div class="me-auto d-flex align-items-center gap-2">
                                                        <span class="badge bg-dark">@vg.Key</span>
                                                    </div>
                                                    <div class="stat">
                                                        <span class="me-3"><i class="bi bi-files"></i> @vFileCount dosya</span>
                                                        <span><i class="bi bi-hdd-network"></i> @SizeFmt(vTotalSize)</span>
                                                    </div>
                                                </button>
                                            </h2>
                                            <div id="@vCollapseId" class="accordion-collapse collapse" aria-labelledby="@vHeadingId" data-bs-parent="#accVersions_@pIndex">
                                                <div class="accordion-body">
                                                    <div class="table-wrap">
                                                        <div class="table-responsive">
                                                            <table class="table table-hover table-striped align-middle mb-0">
                                                                <thead class="table-light">
                                                                    <tr>
                                                                        <th class="w-50">Dosya</th>
                                                                        <th>Tür</th>
                                                                        <th>Boyut</th>
                                                                        <th>Yüklendi</th>
                                                                        <th class="text-end">İşlem</th>
                                                                    </tr>
                                                                </thead>
                                                                <tbody>
                                                                    @foreach (FileListItem x in vg.OrderByDescending(r => r.UploadUtc))
                                                                    {
                                                                        <tr>
                                                                            <td class="text-truncate file-cell" title="@x.FileNameStored">@x.FileNameStored</td>
                                                                            <td><span class="badge bg-outline border">@x.ArchiveType</span></td>
                                                                            <td>@SizeFmt(x.FileSizeBytes)</td>
                                                                            <td>@x.UploadUtc.ToLocalTime().ToString("dd.MM.yyyy HH:mm")</td>
                                                                            <td class="text-end">
                                                                                <div class="btn-group">
                                                                                    <a class="btn btn-primary btn-sm"
                                                                                       asp-action="PromptKv"
                                                                                       asp-route-packageKey="@x.PackageKey"
                                                                                       asp-route-version="@x.Version"
                                                                                       asp-route-fileName="@x.FileNameStored">
                                                                                        <i class="bi bi-download"></i> İndir
                                                                                    </a>
                                                                                </div>
                                                                            </td>
                                                                        </tr>
                                                                    }
                                                                </tbody>
                                                            </table>
                                                        </div>
                                                    </div>
                                                    <div class="cards-wrap">
                                                        <div class="list-group list-group-flush">
                                                            @foreach (FileListItem x in vg.OrderByDescending(r => r.UploadUtc))
                                                            {
                                                                <div class="file-card">
                                                                    <div class="d-flex align-items-start justify-content-between">
                                                                        <div class="me-2">
                                                                            <div class="file-title">@x.FileNameStored</div>
                                                                            <div class="file-meta mt-1">
                                                                                <span class="chip me-2 text-primary">@x.ArchiveType.ToUpper()</span>
                                                                                <span class="me-2">@SizeFmt(x.FileSizeBytes)</span>
                                                                                <span>@x.UploadUtc.ToLocalTime().ToString("dd.MM.yyyy HH:mm")</span>
                                                                            </div>
                                                                        </div>
                                                                        <div class="ms-2 text-nowrap">
                                                                            <a class="btn btn-primary btn-sm"
                                                                               asp-action="PromptKv"
                                                                               asp-route-packageKey="@x.PackageKey"
                                                                               asp-route-version="@x.Version"
                                                                               asp-route-fileName="@x.FileNameStored">
                                                                                <i class="bi bi-download"></i>
                                                                            </a>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            }
                                                        </div>

                                                        <div class="sticky-actions d-md-none">
                                                            <div class="small text-muted"><i class="bi bi-info-circle"></i> Uzun listelerde “İndir” dosya bazında çalışır.</div>
                                                        </div>
                                                    </div>

                                                </div>
                                            </div>
                                        </div>

                                        vIndex++;
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                    pIndex++;
                }
            </div>
        }
    </main>

    <footer class="border-top bg-white py-3 mt-4">
        <div class="container small text-muted">
            © @DateTime.Now.Year Doğukan Koşan • Dosya Merkezi
        </div>
    </footer>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
            crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        (function(){
          const v = document.querySelector('input[name="version"]');
          if(!v) return;
          v.addEventListener('input', () => {
            let s = v.value.replace(/[^0-9.]/g,'');
            s = s.replace(/\.+/g,'.');
            const parts = s.split('.');
            if (parts.length > 3) s = parts.slice(0,3).join('.');
            if (s.startsWith('.')) s = s.replace(/^\.+/,'');
            v.value = s;
          });
        })();
    </script>
    <script>
        (function(){
          const q = document.querySelector('input[name="q"]');
          if(!q) return;
          q.addEventListener('input', () => {
            q.value = q.value.replace(/[\\\/:*?"<>|]/g, '');
          });
          q.addEventListener('blur', () => {
            const v = q.value.trim();
            if (v && !/\.(zip|rar)$/i.test(v)) {
              q.setCustomValidity('Dosya adı .zip veya .rar ile bitmelidir.');
            } else {
              q.setCustomValidity('');
            }
          });
        })();
    </script>
</body>
</html>